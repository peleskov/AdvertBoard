AdvertBoard.grid.Items=function(config){(config=config||{}).id||(config.id="advertboard-grid-items"),Ext.applyIf(config,{url:AdvertBoard.config.connector_url,fields:this.getFields(config),columns:this.getColumns(config),tbar:this.getTopBar(config),sm:new Ext.grid.CheckboxSelectionModel,baseParams:{action:"mgr/item/getlist"},listeners:{rowDblClick:function(grid,rowIndex,e){var row=grid.store.getAt(rowIndex);this.updateItem(grid,e,row)}},viewConfig:{forceFit:!0,enableRowBody:!0,autoFill:!0,showPreview:!0,scrollOffset:0,getRowClass:function(rec){return rec.data.active?"":"advertboard-grid-row-disabled"}},paging:!0,remoteSort:!0,autoHeight:!0}),AdvertBoard.grid.Items.superclass.constructor.call(this,config),this.store.on("load",(function(){this._getSelectedIds().length&&this.getSelectionModel().clearSelections()}),this)},Ext.extend(AdvertBoard.grid.Items,MODx.grid.Grid,{windows:{},getMenu:function(grid,rowIndex){var ids=this._getSelectedIds(),row=grid.getStore().getAt(rowIndex),menu=AdvertBoard.utils.getMenu(row.data.actions,this,ids);this.addContextMenuItem(menu)},createItem:function(btn,e){var w=MODx.load({xtype:"advertboard-item-window-create",id:Ext.id(),listeners:{success:{fn:function(){this.refresh()},scope:this}}});w.reset(),w.setValues({active:!0}),w.show(e.target)},importCreate:function(btn,e){var w=MODx.load({xtype:"advertboard-import-window-create",id:Ext.id(),listeners:{success:{fn:function(){this.refresh()},scope:this}}});w.reset(),w.setValues({active:!0}),w.show(e.target)},updateItem:function(btn,e,row){if(void 0!==row)this.menu.record=row.data;else if(!this.menu.record)return!1;var id=this.menu.record.id;MODx.Ajax.request({url:this.config.url,params:{action:"mgr/item/get",id:id},listeners:{success:{fn:function(r){var w=MODx.load({xtype:"advertboard-item-window-update",id:Ext.id(),record:r,listeners:{success:{fn:function(){this.refresh()},scope:this}}});w.reset(),w.setValues(r.object),w.show(e.target)},scope:this}}})},removeItem:function(){var ids=this._getSelectedIds();return!!ids.length&&(MODx.msg.confirm({title:ids.length>1?_("advertboard_items_remove"):_("advertboard_item_remove"),text:ids.length>1?_("advertboard_items_remove_confirm"):_("advertboard_item_remove_confirm"),url:this.config.url,params:{action:"mgr/item/remove",ids:Ext.util.JSON.encode(ids)},listeners:{success:{fn:function(){this.refresh()},scope:this}}}),!0)},getFields:function(){return["id","pid","user_id","title","hash","actions","top","images","img"]},getColumns:function(){return[{header:_("advertboard_item_id"),dataIndex:"id",sortable:!0,width:50},{header:_("advertboard_item_parent"),dataIndex:"pid",sortable:!0,width:50},{header:_("advertboard_item_author"),dataIndex:"user_id",sortable:!0,width:50},{header:_("advertboard_item_title"),dataIndex:"title",sortable:!0,width:200},{header:_("advertboard_item_hash"),dataIndex:"hash",sortable:!1,width:250},{header:_("advertboard_grid_actions"),dataIndex:"actions",renderer:AdvertBoard.utils.renderActions,sortable:!1,width:50,id:"actions"},{header:_("advertboard_item_top"),dataIndex:"top",sortable:!0,width:30}]},getTopBar:function(){return[{text:'<i class="icon icon-plus"></i>&nbsp;'+_("advertboard_item_create"),handler:this.createItem,scope:this},{text:'<i class="icon icon-download"></i>&nbsp;'+_("advertboard_import_start"),handler:this.importCreate,scope:this},"->",{xtype:"advertboard-field-search",width:250,listeners:{search:{fn:function(field){this._doSearch(field)},scope:this},clear:{fn:function(field){field.setValue(""),this._clearSearch()},scope:this}}}]},onClick:function(e){var elem=e.getTarget();if("BUTTON"==elem.nodeName){var row=this.getSelectionModel().getSelected();if(void 0!==row){var action=elem.getAttribute("action");if("showMenu"==action){var ri=this.getStore().find("id",row.id);return this._showMenu(this,ri,e)}if("function"==typeof this[action])return this.menu.record=row.data,this[action](this,e)}}return this.processEvent("click",e)},_getSelectedIds:function(){var ids=[],selected=this.getSelectionModel().getSelections();for(var i in selected)selected.hasOwnProperty(i)&&ids.push(selected[i].id);return ids},_doSearch:function(tf){this.getStore().baseParams.query=tf.getValue(),this.getBottomToolbar().changePage(1)},_clearSearch:function(){this.getStore().baseParams.query="",this.getBottomToolbar().changePage(1)}}),Ext.reg("advertboard-grid-items",AdvertBoard.grid.Items);